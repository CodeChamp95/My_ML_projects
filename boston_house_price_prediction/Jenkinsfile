pipeline {
  agent any

  environment {
    VENV_DIR = "venv"
    PYTHON = "${env.WORKSPACE}/venv/bin/python"
    PIP = "${env.WORKSPACE}/venv/bin/pip"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Create venv & Install') {
      steps {
        sh '''
          set -e
          echo "Python version:"
          python3 --version || { echo "python3 not found"; exit 1; }

          # create virtualenv (will fail if python3-venv missing)
          python3 -m venv "${VENV_DIR}" || { echo "Failed to create venv. Install python3-venv on agent."; exit 2; }

          . "${VENV_DIR}/bin/activate"

          # pip upgrade and install requirements (use requirements.txt if present in repo)
          ${PIP} install --upgrade pip

          if [ -f requirements.txt ]; then
            echo "Installing from requirements.txt"
            ${PIP} install -r requirements.txt
          else
            echo "No requirements.txt found — installing minimal deps"
            ${PIP} install flask pandas numpy scikit-learn
          fi
        '''
      }
    }

    stage('Verify Files') {
      steps {
        sh '''
          echo "Workspace contents:"
          ls -la

          if [ ! -f "app.py" ]; then
            echo "ERROR: app.py not found in workspace"
            exit 3
          fi

          echo "model.pkl present? " && [ -f "model.pkl" ] && echo "yes" || echo "no"
          echo "scaler.pkl present? " && [ -f "scaler.pkl" ] && echo "yes" || echo "no"
        '''
      }
    }

    stage('Lint / Syntax Check') {
      steps {
        sh '''
          . "${VENV_DIR}/bin/activate"
          ${PYTHON} -m py_compile app.py
          echo "app.py syntax OK"
        '''
      }
    }

    stage('Archive Artifacts') {
      steps {
        archiveArtifacts artifacts: '*.pkl, requirements.txt, *.csv, *.html, *.css', fingerprint: true
      }
    }
  }

  post {
    success {
      echo "Build completed successfully"
    }
    failure {
      echo "Build failed — see logs above"
    }
  }
}
