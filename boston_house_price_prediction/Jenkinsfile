pipeline {
  agent {
    docker {
      image 'python:3.11-slim'
      args '-u root:root'   // run as root inside container so pip can install
    }
  }

  environment {
    PYTHON = "python3"
    PIP = "pip3"
  }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Prepare') {
      steps {
        sh '''
          set -e
          $PIP install --upgrade pip
          # create a requirements file if you don't have one; you can commit it to repo
          cat > requirements.txt <<EOF
          flask
          pandas
          numpy
          scikit-learn
          EOF

          $PIP install -r requirements.txt
        '''
      }
    }

    stage('Verify Files') {
      steps {
        sh '''
          echo "Listing workspace"
          ls -la
          if [ ! -f "app.py" ]; then
            echo "ERROR: app.py not found"
            exit 1
          fi
          if [ ! -f "model.pkl" ]; then
            echo "WARNING: model.pkl not found (if you expect it to be present, commit it)"
          fi
        '''
      }
    }

    stage('Lint') {
      steps {
        sh '''
          $PYTHON -m py_compile app.py
          echo "app.py syntax OK"
        '''
      }
    }

    stage('Archive') {
      steps {
        archiveArtifacts artifacts: '*.pkl, requirements.txt, *.csv, *.html, *.css', fingerprint: true
      }
    }
  }

  post {
    success { echo "Build succeeded" }
    failure { echo "Build failed" }
  }
}
